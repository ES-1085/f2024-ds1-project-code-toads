---
title: "Promise Early Education"
author: "Fred, Soren, Katie K"
output: html_document
---

```{r load-packages, message = FALSE}
library(tidyverse)
library(broom)
library(dplyr)
library(stringr)
```

## 1. Introduction

Our data comes from Promise Early Education, a Head Start and Early Head Start program that works with vulnerable children to encourage educational growth and measures their development in six key areas: social/emotional, physical, and language development, as well literacy, cognitive, and mathematics knowledge and skills. These datasets measure scores in these various domains for children aged 0-5 and determines whether they are meeting expectations based on the expected scores for each age range. The variables include bottom expected scores, top expected scores, # of children, average score, # of children below score range, % of children below score range, # of children in score range, % of children in score range, the domain tested, age of children, the season, and the year.

We are hoping to explore the various trends seen within the promise early education, particularly the effect that the COVID-19 pandemic had on the several categories of child development in the years that followed it.
In order to learn more about the work we are trying to accomplish we are going to set up a meeting with our community partners after break. 


## 2. Data



```{r cleanup fall-18-19}

library(readxl)

library(janitor)

pre_covid_fall_2018_19 <- read_excel("../data/pre_covid.xlsx", 
    sheet = "3-4", range = "A3:I81") |>
  janitor::clean_names()
  

pre_covid_fall_2018_19 <- pre_covid_fall_2018_19 |>
  rename(`category` = `x1`)

pre_covid_fall_2018_19[1, 1] <- "Social-Emotional"


pre_covid_fall_2018_19 <- pre_covid_fall_2018_19 |>
  filter(!category %in% c("Threes SE", "Threes")) 

pre_covid_fall_2018_19 <- pre_covid_fall_2018_19 |>
  fill(category, .direction = "down") |>
  drop_na(bottom)

pre_covid_fall_2018_19 <- pre_covid_fall_2018_19 |>
  filter(!bottom %in% c("Widely Held Expectations", "Bottom"))

pre_covid_fall_2018_19 <- pre_covid_fall_2018_19 |>
  mutate(season = "Fall") |>
  mutate(year = "18-19")

pre_covid_fall_2018_19$percent_meeting_exceeding <- as.numeric(pre_covid_fall_2018_19$percent_meeting_exceeding)

pre_covid_fall_2018_19_mean <- pre_covid_fall_2018_19 |>
  group_by(category) |>
  summarize_at(vars("percent_meeting_exceeding"), mean, na.rm = TRUE)

pre_covid_fall_2018_19_mean

```

```{r cleanup-winter-18-19}
library(readxl)
pre_covid_winter_2018_19 <- read_excel("../data/pre_covid.xlsx", 
    sheet = "3-4", range = "J3:O80")

expectations_18_19 <- read_excel("../data/pre_covid.xlsx", 
    sheet = "3-4", range = "A3:C80")


pre_covid_winter_2018_19 <- cbind(expectations_18_19, pre_covid_winter_2018_19) |>
    janitor::clean_names()

pre_covid_winter_2018_19 <- pre_covid_winter_2018_19 |>
  rename(`category` = `x1`)

pre_covid_winter_2018_19[1, 1] <- "Social-Emotional"


pre_covid_winter_2018_19 <- pre_covid_winter_2018_19 |>
  filter(!category %in% c("Threes SE", "Threes")) 

pre_covid_winter_2018_19 <- pre_covid_winter_2018_19 |>
  fill(category, .direction = "down") |>
  drop_na(bottom)

pre_covid_winter_2018_19 <- pre_covid_winter_2018_19 |>
  filter(!bottom %in% c("Widely Held Expectations", "Bottom"))

pre_covid_winter_2018_19 <- pre_covid_winter_2018_19 |>
  mutate(season = "Winter") |>
   mutate(year = "18-19")

pre_covid_winter_2018_19$percent_meeting_exceeding <- as.numeric(pre_covid_winter_2018_19$percent_meeting_exceeding)

pre_covid_winter_2018_19_mean <- pre_covid_winter_2018_19 |>
  group_by(category) |>
  summarize_at(vars("percent_meeting_exceeding"), mean, na.rm = TRUE)


```

```{r cleanup-spring-18-19}
library(readxl)
pre_covid_spring_2018_19 <- read_excel("../data/pre_covid.xlsx", 
    sheet = "3-4", range = "P3:U80")

pre_covid_spring_2018_19 <- cbind(expectations_18_19, pre_covid_spring_2018_19) |>
    janitor::clean_names()


pre_covid_spring_2018_19 <- pre_covid_spring_2018_19 |>
  rename(`category` = `x1`)

pre_covid_spring_2018_19[1, 1] <- "Social-Emotional"


pre_covid_spring_2018_19 <- pre_covid_spring_2018_19 |>
  filter(!category %in% c("Threes SE", "Threes")) 

pre_covid_spring_2018_19 <- pre_covid_spring_2018_19 |>
  fill(category, .direction = "down") |>
  drop_na(bottom)

pre_covid_spring_2018_19 <- pre_covid_spring_2018_19 |>
  filter(!bottom %in% c("Widely Held Expectations", "Bottom"))

pre_covid_spring_2018_19 <- pre_covid_spring_2018_19 |>
  mutate(season = "Spring") |>
   mutate(year = "18-19")

pre_covid_spring_2018_19$percent_meeting_exceeding <- as.numeric(pre_covid_spring_2018_19$percent_meeting_exceeding)


pre_covid <- rbind(pre_covid_fall_2018_19, pre_covid_winter_2018_19, pre_covid_spring_2018_19) |>
  mutate(season = fct_relevel(season, "Fall", "Winter", "Spring"))

#should we make a variable for age, since the data is split between age groups? or just choose 3-4 year olds as our #data set?
#pre_covid <- pre_covid |>
 # mutate(children_age = "3-4")

pre_covid_spring_2018_19_mean <- pre_covid_spring_2018_19 |>
  group_by(category) |>
  summarize_at(vars("percent_meeting_exceeding"), mean, na.rm = TRUE)


```

```{r first-plots-18-19}

##plots showing mean scores through each season for 2018-19

ggplot(pre_covid_fall_2018_19_mean, aes(y = category, x = percent_meeting_exceeding, fill = category)) +
  geom_col() +
  labs(
    x = "Percent Meeting/Exceeding",
    y = "Category",
    title = "Percent Meeting/Exceeding in Each Category for Fall 2018-19",
    fill = "Category")  +
  xlim(0, 100)


ggplot(pre_covid_winter_2018_19_mean, aes(y = category, x = percent_meeting_exceeding, fill = category)) +
  geom_col() +
  labs(
    x = "Percent Meeting/Exceeding",
    y = "Category",
    title = "Percent Meeting/Exceeding in Each Category for Winter 2018-19",
    fill = "Category") +
  xlim(0, 100)


ggplot(pre_covid_spring_2018_19_mean, aes(y = category, x = percent_meeting_exceeding, fill = category)) +
  geom_col() +
  labs(
    x = "Percent Meeting/Exceeding",
    y = "Category",
    title = "Percent Meeting/Exceeding in Each Category for Spring 2018-19",
    fill = "Category" 
  )  +
  xlim(0, 100)


```

```{r mean-plot-18-19,  fig.alt = c("Bar graphs faceted by test category that show percentage of children at or above expectations over Fall, Winter, and Spring for the year '18-'19. For all categories, Cognitive, Language, Literacy, Mathematics, Physical, and Social-Emotional, there is an upward trend as the year goes on.")}
pre_covid <- pre_covid |>
mutate(across(2:9, as.numeric))

pre_covid[is.na(pre_covid)] <- 0

pre_covid_mean <- pre_covid |>
  group_by(category, season) |>
  summarize_at(vars("percent_meeting_exceeding"), mean, na.rm = TRUE)

ggplot(pre_covid_mean, aes(x = season, y = percent_meeting_exceeding, fill = category)) +
  geom_col() +
  labs(
    y = "Percent Meeting/Exceeding",
    x = "Season",
    title = "Percent of Children Meeting/Exceeding Test Score Expectations",
    subtitle = "For the Year 2018-19",
    fill = "Category")  +
  ylim(0, 100) +
  facet_wrap(~category) +
  guides(fill = "none")+
  theme(
  plot.background = element_rect(fill="white")
  ) +
  scale_fill_viridis_d() 

ggsave("18_19_graphs.png", width = 7.5, height = 5, dpi = 300)

```


```{r cleanup fall_20-21}

fall_2020_21 <- read_excel("../data/2020_21_HS.xlsx", 
    sheet = "HS RAW ALL", range = "A4:K50") |>
    janitor::clean_names()

fall_2020_21 <- fall_2020_21 |>
  rename(`category` = `x1`)

fall_2020_21[1, 1] <- "Social-Emotional"


fall_2020_21 <- fall_2020_21 |>
  filter(!str_detect(category, "TOTAL")) 

fall_2020_21 <- fall_2020_21 |>
 mutate(category = case_when(str_detect(category, pattern = "Language|Mathematics|Social-Emotional|Cognitive|Physical|Literacy") ~ category, TRUE ~ NA))
 
 
 # mutate(category = na_if(category, category == str_detect("Yrs")))
  # mutate(category = case_when(category == str_detect("Lang") ~ "Language",
#category == str_detect(...),
#TRUE ~ "No category"))

fall_2020_21 <- fall_2020_21 |>
  fill(category, .direction = "down") |>
  drop_na(bottom)

fall_2020_21 <- fall_2020_21 |>
  filter(!bottom %in% c("Widely Held Expectations", "Bottom"))

fall_2020_21 <- fall_2020_21 |>
mutate(across(2:11, as.numeric))

fall_2020_21[is.na(fall_2020_21)] <- 0

#fall_2020_21$percent_meeting <- as.numeric(fall_2020_21$percent_meeting) 
 #fall_2020_21$percent_exceeding <- as.numeric(fall_2020_21$percent_exceeding)
 #fall_2020_21$number_meeting <- as.numeric(fall_2020_21$number_meeting)
 #fall_2020_21$number_exceeding <- as.numeric(fall_2020_21$number_exceeding)

fall_2020_21 <- fall_2020_21 |>
  mutate(season = "Fall") |>
   mutate(year = "20-21") 


```


```{r cleanup winter_20-21}

winter_2020_21 <- read_excel("../data/2020_21_HS.xlsx", 
    sheet = "HS RAW ALL", range = "N4:U50") |>
    janitor::clean_names()

expectations_20_21 <- read_excel("../data/2020_21_HS.xlsx", 
    sheet = "HS RAW ALL", range = "A4:C50")

winter_2020_21 <- cbind(expectations_20_21, winter_2020_21) |>
      janitor::clean_names()
  

winter_2020_21 <- winter_2020_21 |>
  rename(`category` = `x1`)

winter_2020_21[1, 1] <- "Social-Emotional"

winter_2020_21 <- winter_2020_21 |>
  filter(!str_detect(category, "TOTAL")) 

winter_2020_21 <- winter_2020_21 |>
 mutate(category = case_when(str_detect(category, pattern = "Language|Mathematics|Social-Emotional|Cognitive|Physical|Literacy") ~ category, TRUE ~ NA))
 

winter_2020_21 <- winter_2020_21 |>
  fill(category, .direction = "down") |>
  drop_na(bottom)

winter_2020_21 <- winter_2020_21 |>
  filter(!bottom %in% c("Widely Held Expectations", "Bottom"))


winter_2020_21$percent_meeting <- as.numeric(winter_2020_21$percent_meeting) 
 winter_2020_21$percent_exceeding <- as.numeric(winter_2020_21$percent_exceeding)
 winter_2020_21$number_meeting <- as.numeric(winter_2020_21$number_meeting)
 winter_2020_21$number_exceeding <- as.numeric(winter_2020_21$number_exceeding)

winter_2020_21 <- winter_2020_21 |>
  mutate(season = "Winter") |>
   mutate(year = "20-21")

glimpse(pre_covid_fall_2018_19)

```


```{r cleanup spring_20-21}

spring_2020_21 <- read_excel("../data/2020_21_HS.xlsx", 
    sheet = "HS RAW ALL", range = "X4:AE50") |>
    janitor::clean_names()

spring_2020_21 <- cbind(expectations_20_21, spring_2020_21) |>
      janitor::clean_names()
  

spring_2020_21 <- spring_2020_21 |>
  rename(`category` = `x1`)

spring_2020_21[1, 1] <- "Social-Emotional"

spring_2020_21 <- spring_2020_21 |>
  filter(!str_detect(category, "TOTAL")) 

spring_2020_21 <- spring_2020_21 |>
 mutate(category = case_when(str_detect(category, pattern = "Language|Mathematics|Social-Emotional|Cognitive|Physical|Literacy") ~ category, TRUE ~ NA))
 
 
 # mutate(category = na_if(category, category == str_detect("Yrs")))
  # mutate(category = case_when(category == str_detect("Lang") ~ "Language",
#category == str_detect(...),
#TRUE ~ "No category"))

spring_2020_21 <- spring_2020_21 |>
  fill(category, .direction = "down") |>
  drop_na(bottom)

spring_2020_21 <- spring_2020_21 |>
  filter(!bottom %in% c("Widely Held Expectations", "Bottom"))

spring_2020_21 <- spring_2020_21 |>
mutate(across(2:11, as.numeric))

spring_2020_21$percent_meeting <- as.numeric(spring_2020_21$percent_meeting) 
 spring_2020_21$percent_exceeding <- as.numeric(spring_2020_21$percent_exceeding)
 spring_2020_21$number_meeting <- as.numeric(spring_2020_21$number_meeting)
 spring_2020_21$number_exceeding <- as.numeric(spring_2020_21$number_exceeding)

spring_2020_21 <- spring_2020_21 |>
  mutate(season = "Spring") |>
   mutate(year = "20-21")# |>

```

```{r merge 2020-21}

covid_2020_21 <- rbind(fall_2020_21, winter_2020_21, spring_2020_21) |>
  mutate(season = fct_relevel(season, "Fall", "Winter", "Spring"))

covid_2020_21 <- covid_2020_21 |>
mutate(across(2:11, as.numeric))

covid_2020_21[is.na(covid_2020_21)] <- 0

covid_2020_21 <- covid_2020_21 |>
  mutate(number_meeting_exceeding = number_meeting + number_exceeding) |>
mutate(percent_meeting_exceeding = percent_meeting + percent_exceeding) |>
  select(-season, season) |>
  select(-year, year)

covid_2020_21 <- covid_2020_21 |>
  select(-(number_meeting:percent_exceeding))

```


```{r merge 2018-2021}

scores <- rbind(pre_covid, covid_2020_21)

```

```{r post-covid-fall-cleanup}
library(readxl)

library(janitor)

post_covid <- read_excel("../data/post_covid.xlsx",
  range = "A3:K65") |>
  janitor::clean_names()

post_covid <- post_covid |>
  rename(`category` = `x1`)






post_covid <- post_covid %>% filter(!if_all(-1, is.na)) #removes rows of all NA
post_covid <- post_covid[, -c(2,3)]
post_covid <- post_covid %>% filter(!is.na(average))



post_covid[1:5, 1] <- "Social-Emotional"
post_covid[6:10, 1] <- "Physical"
post_covid[11:15, 1] <- "Language"
post_covid[16:20, 1] <- "Cognitive"
post_covid[21:25, 1] <- "Literacy"
post_covid[26:30, 1] <- "Mathematics"

#view(post_covid)
fall <- post_covid[-c(5, 10, 15, 20, 25, 30), ]
#view(fall)



```

```{r post-covid-winter-spr-cleanup}
post_covid_win_spr <- read_excel("../data/post_covid.xlsx",
  range = "M3:AE65") |>
  janitor::clean_names()

post_covid_win_spr <- post_covid_win_spr |>
  rename(`category` = `x1`) |>
  rename(`category_1` = `x11`)


post_covid_win_spr <- post_covid_win_spr %>% filter(!if_all(-1, is.na)) #removes rows of all NA
post_covid_win_spr <- post_covid_win_spr %>% filter(!is.na(average_3))




post_covid_win_spr[1:5, 1] <- "Social-Emotional"
post_covid_win_spr[6:10, 1] <- "Physical"
post_covid_win_spr[11:15, 1] <- "Language"
post_covid_win_spr[16:20, 1] <- "Cognitive"
post_covid_win_spr[21:25, 1] <- "Literacy"
post_covid_win_spr[26:30, 1] <- "Mathematics"

post_covid_win_spr[1:5, 11][is.na(post_covid_win_spr[1:5, 10])] <- "Social-Emotional"
post_covid_win_spr[6:10, 11][is.na(post_covid_win_spr[6:10, 10])] <- "Physical"
post_covid_win_spr[11:15, 11][is.na(post_covid_win_spr[11:15, 10])] <- "Language"
post_covid_win_spr[16:20, 11][is.na(post_covid_win_spr[16:20, 10])] <- "Cognitive"
post_covid_win_spr[21:25, 11][is.na(post_covid_win_spr[21:25, 10])] <- "Literacy"
post_covid_win_spr[26:30, 11][is.na(post_covid_win_spr[26:30, 10])] <- "Mathematics"



post_covid_win_spr <- post_covid_win_spr[-c(5, 10, 15, 20, 25, 30),]
post_covid_win_spr <- post_covid_win_spr[, -c(10)]

#view(post_covid_win_spr)



```

```{r merging-post_covid}
#create season column
fall <- fall %>%
  mutate(season = "Fall")
#view(fall)

winter <- post_covid_win_spr[, 1:9]  # Columns 1 to 10
winter <- winter %>%
  mutate(season = "Winter")

spring <- post_covid_win_spr[, 10:ncol(post_covid_win_spr)]
spring <- spring %>%
  mutate(season = "Spring")

#rename columns
colnames(winter) <- c("category", "number_children", "average", "number_below", "percent_below", 
                                  "number_meeting", "percent_meeting", "number_exceeding", "percent_exceeding", "season")
#view(winter)

colnames(spring) <- c("category", "number_children", "average", "number_below", "percent_below", 
                                  "number_meeting", "percent_meeting", "number_exceeding", "percent_exceeding", "season")
#view(spring)

#merge dfs

post_covid_final  <- rbind(fall, winter, spring)

#view(post_covid_final)
              
post_covid_final <- post_covid_final |>
mutate(across(2:9, as.numeric))          

#post_covid_final[is.na(post_covid_final)] <- 0

post_covid_final <- post_covid_final |>
  mutate(number_meeting_exceeding = number_meeting + number_exceeding) |>
mutate(percent_meeting_exceeding = percent_meeting + percent_exceeding) |>
 mutate(year = "22-23") |>
  select(-season, season) |>
  select(-year, year)

post_covid_final <- post_covid_final |>
  select(-(number_meeting:percent_exceeding))



```

```{r plots}

score_fallspring <- scores |>
  filter(season != "Winter") |>
  group_by(category, season, year) |>
  summarize(score_mean = mean(percent_meeting_exceeding))


score_fallspring_wide <- score_fallspring |>
  pivot_wider(names_from = season,
              values_from = score_mean) |>
  mutate(percent_increase = Spring - Fall) #|>
 # pivot_wider(names_from = year,
  #            values_from = percent_increase)


##score_fallspring_wide |>
 ## summarize(percent_increase,-category)

#result <- score_fallspring_wide[seq(1, nrow(score_fallspring_wide), 2),] - score_fallspring_wide[seq(2, nrow(score_fallspring_wide), 2),] 

```

```{r final-combine}

scores<-scores |>
  select(-(bottom:top))


scores <- rbind(scores, post_covid_final)

scores[is.na(scores)] <- 0

scores_mean <- scores |>
  group_by(category, season,year) |>
  summarize_at(vars("percent_meeting_exceeding"), mean, na.rm = TRUE)

```

```{r covid-line-plot, fig.alt = c("Three line plots faceted by year that show the percentage of children that scored at or above expectations, with one line for each category. There is an upward trend for all categories in the years `18-`19 and `20-`21")}



ggplot(scores_mean, aes(x = season, y = percent_meeting_exceeding, group = category, color = category)) +
  geom_line() + 
  geom_point() +
  labs(
    title = "Academic Performance by Category Across Seasons",
    subtitle = "Grouped by COVID-19 Era: Pre, During, and Post",
    x = "Season",
    y = "Percent Meeting/Exceeding",
    color = "Category",
  ) +
  facet_wrap(~ year, ncol = 3) +
  scale_color_brewer(palette = "RdBu")+ 
  theme_minimal() +
  theme(
  legend.position = "bottom",
  legend.direction = "horizontal",
plot.background = element_rect(fill="white")  
)

ggsave("covid_line_plot.png", width = 8.5, height = 5, dpi = 300)
```




```{r category-heatmap, fig.alt = c("Heat map that shows the percentage of children that scored below expectation or meeting/exceeding expectations in test scores for different categories across seasons and years. All seasons across the year '22-'23 generally have lower percentage of children at or above the threshold")}

scores_mean <- scores_mean %>%
  mutate(period_season = paste(year, season, sep = "-"))

scores_mean <- scores_mean %>%
  mutate(
    percent_below = 100 - percent_meeting_exceeding
  )

scores_long <- scores_mean %>%
  pivot_longer(
    cols = c(percent_meeting_exceeding, percent_below),
    names_to = "type",
    values_to = "percent"
  )


scores_long_combined <- scores_long %>%
  mutate(status = ifelse(type == "percent_meeting_exceeding", "Meeting/Exceeding", "Below Expectations"))




library(ggplot2)

ggplot(scores_long_combined, aes(x = period_season, y = category, fill = percent)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "lightyellow", high = "darkred") +
  labs(
    title = "Student Performance Across COVID Periods and Seasons",
    x = "Year - Season",
    y = "Category",
    fill = "% of Students"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), # slanting labels
    plot.background = element_rect(fill="white")  
  )



ggsave("performance_heatmap.png", width = 7.5, height = 4.5, dpi = 300)






```

## 3. Data analysis plan
We are going to be exploring patterns before and after COVID-19 to visualize the effect that the COVID-19 pandemic has had on the several categories of child development. One variable that is going to be useful in this is,% Meeting/Exceeding, t`o see if these numbers differed before and after COVID-19. We intend to create a scatter plot, and use faceting since they are many different times we are comparing.  We have so much data, so we don't think we need additional data, but we are going to need to tidy up the data to make it easier to analyze.



## 4. Data Ethics Review

In regards to the negative effects, one data file has information on the names of the students involved in the program, and that is one example of sensitive information that could be harmful if included in our project. To minimize this harm, we should be mindful of not including any information that is not completely relevant or could be used to single out specific students, especially given the fact that this dataset works with young participants. Another, data ethics concern is how we have no connection to the students represented in the data set. It is easy to see their development through the data but we have to remember that this data represent real students. We have not yet been in contact with our community partners so that communication will be helpful to understand the behind the scenes of the data. 


